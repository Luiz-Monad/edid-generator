#!/usr/bin/env python3
import sys
import re
import math
from pathlib import Path

SUPPORTED_RATIOS = ["16:10", "16:9", "4:3", "5:4"]

def find_supported_ratio(x, y, default="UNKNOWN", ratios=None):
    if ratios is None or len(ratios) == 0:
        ratios = SUPPORTED_RATIOS

    best_r = None
    best_v = None

    for r in ratios:
        rx, ry = map(int, r.split(":"))
        v = abs(x / rx - y / ry)
        if best_v is None or v < best_v:
            best_v = v
            best_r = r

    return best_r if best_r else default


def template_S(tokens):
    # Must match "mode" or "modeline"
    if tokens[0].lower() not in ("mode", "modeline"):
        return False

    print("-- Found modeline:", " ".join(tokens))

    tokens = tokens[1:]  # remove "mode|modeline"

    # NAME
    name = tokens[0].replace('"', '')
    if not name:
        print("Could not parse modeline:", tokens, file=sys.stderr)
        return False
    m = re.match(r'(.+_\d+)\.\d+$', name)
    if m:
        name = m.group(1)        
    if len(name) > 12:
        print(f"Warning: name '{name}' too long ({len(name)} chars). Shortening to 12 chars.")
        name = name[:12]
    fn = f"{name}.S"

    # CLOCK
    try:
        pixel_clock_mhz = float(tokens[1])
    except:
        print("Invalid pixel clock", file=sys.stderr)
        return False

    pixel_clock_khz = int(pixel_clock_mhz * 1000)
    tokens = tokens[2:]

    # GEOMETRY
    try:
        hdisp, hsyncstart, hsyncend, htotal = map(int, tokens[:4])
        vdisp, vsyncstart, vsyncend, vtotal = map(int, tokens[4:8])
    except:
        print("Invalid timing values", file=sys.stderr)
        return False

    tokens = tokens[8:]

    # defaults
    hsync_pol = 0
    vsync_pol = 0
    dpi = 96
    vfreq_hz = 60
    edid_version = "1.3"
    ratio = "compute"

    # parse flags
    for arg in tokens:
        a = arg.lower()
        if a.endswith("hsync"):
            if arg.startswith("+"):
                hsync_pol = 1
        elif a.endswith("vsync"):
            if arg.startswith("+"):
                vsync_pol = 1
        elif a.startswith("ratio=") or a.startswith("xy_ratio="):
            ratio = arg.split("=")[1]
        elif a.startswith("dpi="):
            dpi = int(arg.split("=")[1])
        elif a.startswith("edid_version="):
            edid_version = arg.split("=")[1]
        elif a.startswith("vfreq=") or a.startswith("vfreq_hz="):
            vfreq_hz = int(arg.split("=")[1])
        else:
            print(f"Ignoring unknown modeline option: '{arg}'", file=sys.stderr)

    # compute ratio
    if ratio == "compute":
        ratio = find_supported_ratio(hdisp, vdisp)
        print("Computed ratio:", ratio)
        if ratio == "UNKNOWN":
            return False

    # prepare defines
    version_major, version_minor = edid_version.split(".")

    defines = {
        "TIMING_NAME": f"\"{name}\"",
        "CLOCK": pixel_clock_khz,
        "XPIX": hdisp,
        "XBLANK": (htotal - hdisp),
        "XOFFSET": (hsyncstart - hdisp),
        "XPULSE": (hsyncend - hsyncstart),
        "YPIX": vdisp,
        "YBLANK": (vtotal - vdisp),
        "YOFFSET": f"(63+{vsyncstart - vdisp})",
        "YPULSE": f"(63+{vsyncend - vsyncstart})",
        "VERSION": version_major,
        "REVISION": version_minor,
        "XY_RATIO": f"XY_RATIO_{ratio.upper().replace(':', '_')}",
        "DPI": dpi,
        "VFREQ": vfreq_hz,
        "HSYNC_POL": hsync_pol,
        "VSYNC_POL": vsync_pol,
    }

    # write file
    lines = [f"/* {name}: {' '.join(tokens)} */"]
    for k, v in defines.items():
        lines.append(f"#define {k} {v}")
    lines.append('#include "edid.S"')

    Path(fn).write_text("\n".join(lines) + "\n", encoding="utf-8")
    print(f"Wrote {fn}")
    return True


def main():
    # help
    if len(sys.argv) > 1 and sys.argv[1] in ("-h", "--help"):
        print(f"""{Path(sys.argv[0]).name}, version forever 0.0.1
Help:
  {Path(sys.argv[0]).name} -h
Parse modelines from stdin:
  {Path(sys.argv[0]).name}
  {Path(sys.argv[0]).name} -
Parse modelines from a file:
  {Path(sys.argv[0]).name} FILENAME
""")
        return 1

    # file or stdin
    if len(sys.argv) <= 1 or sys.argv[1] == "-":
        f = sys.stdin
        print("Searching for modelines in stdin")
    else:
        filename = sys.argv[1]
        print(f"Searching for modelines in '{filename}'")
        f = open(filename, "r", encoding="utf-8")

    ret = 0
    for line in f:
        line = line.strip()
        if not line:
            continue
        tokens = line.split()
        ok = template_S(tokens)
        if not ok:
            ret = 1

    return ret


if __name__ == "__main__":
    sys.exit(main())
